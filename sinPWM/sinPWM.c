#include <Arduino.h>
#include <avr/interrupt.h>
#include <math.h>

#define pi 3.1415926535897932384626433832795
#define TOP0 256
#define TOP1 256
#define TOP2 256
#define M 0.7
#define F 50.0

volatile double t = 0.0;
volatile byte TEST = 0;

int va[201] = {128, 132, 136, 139, 143, 147, 151, 155, 159, 163, 167, 171, 174, 178, 182, 185, 189, 192, 196, 199, 202, 206, 209, 212, 215, 218, 220, 223, 226, 228, 231, 233, 235, 237, 239, 241, 243, 245, 246, 247, 249, 250, 251, 252, 253, 253, 254, 254, 255, 255, 255, 255, 255, 254, 254, 253, 253, 252, 251, 250, 249, 247, 246, 245, 243, 241, 239, 237, 235, 233, 231, 228, 226, 223, 220, 218, 215, 212, 209, 206, 202, 199, 196, 192, 189, 185, 182, 178, 174, 171, 167, 163, 159, 155, 151, 147, 143, 139, 136, 132, 128, 123, 119, 116, 112, 108, 104, 100, 96, 92, 88, 84, 81, 77, 73, 70, 66, 63, 59, 56, 53, 49, 46, 43, 40, 37, 35, 32, 29, 27, 24, 22, 20, 18, 16, 14, 12, 10, 9, 8, 6, 5, 4, 3, 2, 2, 1, 1, 0, 0, 0, 0, 0, 1, 1, 2, 2, 3, 4, 5, 6, 8, 9, 10, 12, 14, 16, 18, 20, 22, 24, 27, 29, 32, 35, 37, 40, 43, 46, 49, 53, 56, 59, 63, 66, 70, 73, 77, 81, 84, 88, 92, 96, 100, 104, 108, 112, 116, 119, 123};
int vb[201] = {238, 236, 234, 231, 229, 227, 224, 221, 219, 216, 213, 210, 207, 204, 200, 197, 194, 190, 187, 183, 179, 176, 172, 168, 164, 160, 157, 153, 149, 145, 141, 137, 133, 129, 125, 121, 117, 113, 109, 105, 101, 97, 93, 89, 86, 82, 78, 74, 71, 67, 64, 60, 57, 54, 50, 47, 44, 41, 38, 35, 33, 30, 28, 25, 23, 21, 18, 16, 15, 13, 11, 9, 8, 7, 5, 4, 3, 3, 2, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 2, 3, 4, 5, 6, 7, 8, 10, 12, 13, 15, 17, 19, 21, 24, 26, 28, 31, 34, 36, 39, 42, 45, 48, 51, 55, 58, 61, 65, 68, 72, 76, 79, 83, 87, 91, 95, 98, 102, 106, 110, 114, 118, 122, 126, 130, 134, 138, 142, 146, 150, 154, 158, 162, 166, 169, 173, 177, 181, 184, 188, 191, 195, 198, 201, 205, 208, 211, 214, 217, 220, 222, 225, 227, 230, 232, 234, 237, 239, 240, 242, 244, 246, 247, 248, 250, 251, 252, 252, 253, 254, 254, 255, 255, 255, 255, 255, 255, 254, 254, 253, 252, 251, 250, 249, 248, 247, 245, 243, 242, 240};
int vc[201] = {17, 15, 13, 12, 10, 8, 7, 6, 5, 4, 3, 2, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 2, 3, 3, 4, 5, 7, 8, 9, 11, 13, 15, 16, 18, 21, 23, 25, 28, 30, 33, 35, 38, 41, 44, 47, 50, 54, 57, 60, 64, 67, 71, 74, 78, 82, 86, 89, 93, 97, 101, 105, 109, 113, 117, 121, 125, 129, 133, 137, 141, 145, 149, 153, 157, 160, 164, 168, 172, 176, 179, 183, 187, 190, 194, 197, 200, 204, 207, 210, 213, 216, 219, 221, 224, 227, 229, 231, 234, 236, 238, 240, 242, 243, 245, 247, 248, 249, 250, 251, 252, 253, 254, 254, 255, 255, 255, 255, 255, 255, 254, 254, 253, 252, 252, 251, 250, 248, 247, 246, 244, 242, 240, 239, 237, 234, 232, 230, 227, 225, 222, 220, 217, 214, 211, 208, 205, 201, 198, 195, 191, 188, 184, 181, 177, 173, 169, 166, 162, 158, 154, 150, 146, 142, 138, 134, 130, 126, 122, 118, 114, 110, 106, 102, 98, 95, 91, 87, 83, 79, 76, 72, 68, 65, 61, 58, 55, 51, 48, 45, 42, 39, 36, 34, 31, 28, 26, 24, 21, 19};

ISR (TIMER1_OVF_vect){        //TIMER1_OVF_vect
    
    OCR0A = va[i];           // PWM Pin 6
    OCR0B = vb[i];           // PWM Pin 5
    OCR2A = vc[i];           // PWM Pin 11

    i++;
    if (i >= 200){
        i = 0;
        digitalWrite(2, TEST);
        TEST = ~TEST;
    } 
}

void setup() {
    pinMode(2, OUTPUT);

    cli();//stop interrupts

    // PWM by timer 0 ---------------------------------------------------
    TCNT0 = 0;
    TCCR0A = 0; TCCR0B = 0; // Reset 2 registers
    DDRD |= (1 << PD5);     // PD5 is OUTPUT (pin 5)
    DDRD |= (1 << PD6);     // PB1 is OUTPUT (pin 6 )   
    
    // TCCR0A |= (1 << WGM01) | (1 << WGM00);   // Fast PWM
    TCCR0A |= (1 << WGM00);   // PWM Phase Corrected - Top = 0xFF
    TCCR0A |= (1 << COM0B1);  // Fast mode Pin 5
    TCCR0A |= (1 << COM0A1);  // Fast mode Pin 6
    TCCR0A |= (1 << COM0A1);  // None-inverted mode Pin 6
    TCCR0A |= (1 << COM0B1);  // None-inverted mode Pin 5
    // TCCR0A |= (1 << COM0B1) | (1 << COM0B0);  // inverted mode Pin 5
    TCCR0B |= (1 << CS10);   // No Prescaling = F_Clock or F_clock/1=16mhz
    // TCCR0B = TCCR0B & B11111000 | B00000001; // for PWM frequency ofÂ 62500.00 Hz
    
    
    // PWM by timer 2 and Interrupt ---------------------------------------------------
    TCNT2 = 0;
    TCCR2A = 0; TCCR2B = 0;
    DDRD |= (1 << PD3);   // output Pin 3
    DDRB |= (1 << PB3);   // output Pin 11
    TCCR2A |= (1 << COM2A1);    // None-inverted Pin 11
    TCCR2A |= (1 << COM2B1) | (1 << COM2B0);    // inverted Pin 3
    // TCCR2A |= (1 << WGM21) | (1 << WGM20);      // Fast PWM
    TCCR2A |= (1 << WGM20);      // PWM Phase Corrected - Top = 0xFF
    TCCR2B |= (0 << CS22) | (0 << CS21) | (1 << CS20);  // Prescaler
    

    // PWM by timer 1 & Interrupt-------------------------------------------------
    TCNT1 = 0;
    TCCR1A = 0; TCCR1B = 0; // Reset 2 registers
    DDRB |= (1 << PB2);     // PB2 is OUTPUT (pin 10)
    DDRB |= (1 << PB1);     // PB1 is OUTPUT (pin 9 )   
    
    TCCR1A |= (1 << WGM11);
    TCCR1B |= (1 << WGM12)|(1 << WGM13); // select Fast PWM mode select TOP_value freely ICR1                     
    TCCR1A |= (1 << COM1B1); // None-inverted mode
    TCCR1A |= (1 << COM1A1);    // None-inverted mode Pin 9
    // TCCR1A |= (1 << COM1B1) | (1 << COM1B0);  // inverted mode Pin 10
    ICR1 = 1599;                // Frequency = 16M / ICR1
    TCCR1B |= (1 << CS10);              // No Prescaling = F_Clock or F_clock/1=16mhz
    TIMSK1 |= (1 << TOIE1);         // Timer1 Overflow Interrupt Enable

    TCNT0 = 0;
    TCNT2 = 0;
    sei();
}

void loop() {
    // analogA0 = analogRead(A0);
}
